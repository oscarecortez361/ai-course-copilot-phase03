import streamlit as st, json
from app.backend import Backend

st.set_page_config(page_title="AI Course Copilot ‚Äì MVP", page_icon="üéì", layout="wide")

st.sidebar.title("Settings")
k = st.sidebar.slider("Top-k passages", 3, 10, 5)
show_sources_only = st.sidebar.checkbox("Show sources only", value=False)

@st.cache_resource
def get_be():
    return Backend("app/settings.yaml")

be = get_be()

st.title("AI Course Copilot ‚Äì Integrated Prototype (Phase 04)")
st.caption("Ask a question about your approved course docs. Answers include citations.")

# sample buttons
try:
    SAMPLES = [json.loads(x)["q"] for x in open("app/sample_queries.jsonl","r",encoding="utf-8") if x.strip()]
except Exception:
    SAMPLES = ["What is the grading policy?", "When is the Phase 02 deliverable due?"]

cols = st.columns(min(4, len(SAMPLES)))
for i, q in enumerate(SAMPLES[:4]):
    if cols[i].button(q):
        st.session_state["q"] = q

query = st.text_input("Your question", value=st.session_state.get("q",""))

if st.button("Ask") or query.strip():
    if not query.strip():
        st.warning("Please enter a question.")
    else:
        results = be.retrieve(query, k=k)
        if show_sources_only:
            st.subheader("Top passages")
            for r in results:
                with st.expander(f"{r['doc_title']} ‚Ä¢ {r['chunk_id']} ‚Ä¢ {r['score']:.3f}"):
                    st.write(r["text"])
        else:
            ans, cites = be.answer_extractive(query, results)
            st.subheader("Answer")
            st.write(ans)
            st.caption(f"Citations: {', '.join(cites) if cites else '‚Äî'}")

            st.markdown("---")
            st.write("Was this helpful?")
            c1, c2, c3 = st.columns([1,1,4])
            helpful = None
            if c1.button("üëç Yes"):
                helpful = True
            if c2.button("üëé No"):
                helpful = False
            comment = c3.text_input("Optional feedback")
            if helpful is not None:
                be.record_feedback(query, ans, helpful, comment)
                st.success("Thanks! Feedback saved.")

st.caption("Prototype. Approved documents only; no PII.")
